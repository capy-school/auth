---
import Layout from '../../layouts/Layout.astro';
import { auth } from '../../lib/auth';

let session: any;
const isLocal = ['localhost', '127.0.0.1', '::1'].includes(Astro.url.hostname);
if (isLocal) {
  session = {
    name: 'John Doe',
    email: 'john.doe@example.com',
    role: 'user',
    emailVerified: true,
    image: ''
  };
} else {
  session = await auth.api.getSession({ headers: Astro.request.headers });
  if (!session) {
    return Astro.redirect('/');
  }
}
---

<Layout title="Two-Factor Authentication - Security Settings">
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto">
      <div class="mb-6">
        <a href="/dashboard" class="inline-flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Dashboard
        </a>
      </div>

      <div class="bg-gray-800/50 backdrop-blur-lg rounded-3xl shadow-2xl p-8 border border-gray-700">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">Two-Factor Authentication</h1>
          <p class="text-gray-400">Add an extra layer of security to your account</p>
        </div>

        <div class="bg-gradient-to-br from-blue-900/20 to-purple-900/20 border border-blue-700/50 rounded-lg p-5 mb-6">
          <div class="flex gap-3">
            <svg class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <h3 class="text-blue-300 font-semibold mb-1">About 2FA</h3>
              <p class="text-blue-200/80 text-sm">Two-factor authentication requires both your password and a verification code from your phone to sign in.</p>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <div id="2faStatus" class="bg-gray-700/40 border border-gray-600/50 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="p-2 bg-gray-600/50 rounded-lg">
                  <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Status</h3>
                  <p id="statusText" class="text-sm text-gray-400">Not enabled</p>
                </div>
              </div>
              <button 
                id="toggleBtn"
                class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-medium rounded-lg transition-all shadow-md hover:shadow-lg"
              >
                Enable 2FA
              </button>
            </div>
          </div>

          <div id="setupSection" class="hidden space-y-6">
            <div class="bg-gray-700/40 border border-gray-600/50 rounded-xl p-6">
              <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                <span class="flex items-center justify-center w-6 h-6 bg-purple-600 text-white text-sm rounded-full">1</span>
                Download an Authenticator App
              </h3>
              <p class="text-gray-400 text-sm mb-4">Install one of these apps on your phone:</p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <a href="https://support.google.com/accounts/answer/1066447" target="_blank" rel="noopener noreferrer" class="bg-gray-800/50 hover:bg-gray-700/50 rounded-lg p-3 border border-gray-700/50 hover:border-gray-600 transition-all cursor-pointer">
                  <div class="font-medium text-white text-sm mb-1">Google Authenticator</div>
                  <div class="text-xs text-gray-400">iOS & Android</div>
                </a>
                <a href="https://www.microsoft.com/en-us/security/mobile-authenticator-app" target="_blank" rel="noopener noreferrer" class="bg-gray-800/50 hover:bg-gray-700/50 rounded-lg p-3 border border-gray-700/50 hover:border-gray-600 transition-all cursor-pointer">
                  <div class="font-medium text-white text-sm mb-1">Microsoft Authenticator</div>
                  <div class="text-xs text-gray-400">iOS & Android</div>
                </a>
                <a href="https://authy.com/download/" target="_blank" rel="noopener noreferrer" class="bg-gray-800/50 hover:bg-gray-700/50 rounded-lg p-3 border border-gray-700/50 hover:border-gray-600 transition-all cursor-pointer">
                  <div class="font-medium text-white text-sm mb-1">Authy</div>
                  <div class="text-xs text-gray-400">iOS & Android</div>
                </a>
                <a href="https://1password.com/" target="_blank" rel="noopener noreferrer" class="bg-gray-800/50 hover:bg-gray-700/50 rounded-lg p-3 border border-gray-700/50 hover:border-gray-600 transition-all cursor-pointer">
                  <div class="font-medium text-white text-sm mb-1">1Password</div>
                  <div class="text-xs text-gray-400">iOS, Android & Desktop</div>
                </a>
              </div>
            </div>

            <div class="bg-gray-700/40 border border-gray-600/50 rounded-xl p-6">
              <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                <span class="flex items-center justify-center w-6 h-6 bg-purple-600 text-white text-sm rounded-full">2</span>
                Scan QR Code
              </h3>
              <div class="flex flex-col items-center gap-4">
                <div id="qrContainer" class="bg-white p-4 rounded-lg">
                  <canvas id="qrCode" width="256" height="256"></canvas>
                </div>
                <div class="text-center">
                  <p class="text-gray-400 text-sm mb-2">Or enter this code manually:</p>
                  <code id="secretCode" class="text-sm font-mono text-green-400 bg-gray-900/50 px-4 py-2 rounded border border-gray-700">XXXX XXXX XXXX XXXX</code>
                </div>
              </div>
            </div>

            <div class="bg-gray-700/40 border border-gray-600/50 rounded-xl p-6">
              <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                <span class="flex items-center justify-center w-6 h-6 bg-purple-600 text-white text-sm rounded-full">3</span>
                Enter Verification Code
              </h3>
              <form id="verifyForm" class="flex flex-col sm:flex-row gap-3">
                <input 
                  id="verifyCode" 
                  type="text"
                  placeholder="000000" 
                  maxlength="6"
                  pattern="[0-9]{6}"
                  required
                  class="flex-1 px-4 py-2.5 bg-gray-800/80 border border-gray-600 rounded-lg text-white placeholder-gray-400 text-center text-lg tracking-widest font-mono focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                />
                <button 
                  type="submit" 
                  class="px-6 py-2.5 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium rounded-lg transition-all shadow-md hover:shadow-lg"
                >
                  Verify & Enable
                </button>
              </form>
            </div>

            <button 
              id="cancelBtn"
              class="w-full px-4 py-2 text-gray-400 hover:text-white transition-colors"
            >
              Cancel Setup
            </button>
          </div>

          <div id="backupCodes" class="hidden bg-gradient-to-br from-amber-900/20 to-orange-900/20 border border-amber-700/50 rounded-xl p-6">
            <div class="flex gap-3 mb-4">
              <svg class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <div class="flex-1">
                <h3 class="text-amber-300 font-semibold mb-1">Backup Codes</h3>
                <p class="text-amber-200/80 text-sm mb-4">Save these backup codes in a secure place. Each can be used once if you lose access to your authenticator.</p>
                <div class="grid grid-cols-2 gap-2">
                  <code class="bg-gray-900/50 px-3 py-2 rounded text-sm font-mono text-gray-300">1234-5678</code>
                  <code class="bg-gray-900/50 px-3 py-2 rounded text-sm font-mono text-gray-300">8765-4321</code>
                  <code class="bg-gray-900/50 px-3 py-2 rounded text-sm font-mono text-gray-300">2468-1357</code>
                  <code class="bg-gray-900/50 px-3 py-2 rounded text-sm font-mono text-gray-300">9753-1246</code>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script is:inline src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script is:inline>
  const STORAGE_KEY = '2fa_enabled';
  
  const generateSecret = () => {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let secret = '';
    for (let i = 0; i < 16; i++) {
      secret += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return secret;
  };

  const formatSecret = (secret) => {
    return secret.match(/.{1,4}/g).join(' ');
  };

  const generateQRCode = (secret) => {
    const canvas = document.getElementById('qrCode');
    if (!canvas) {
      console.error('Canvas element not found');
      return;
    }
    
    // Check if QRCode library is loaded
    if (typeof QRCode === 'undefined') {
      console.error('QRCode library not loaded');
      setTimeout(() => generateQRCode(secret), 100); // Retry after 100ms
      return;
    }
    
    // Create TOTP URI - compatible with all authenticator apps including 1Password
    const issuer = 'CapySchool';
    const accountName = window.location.hostname;
    const otpauth = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(accountName)}?secret=${secret}&issuer=${encodeURIComponent(issuer)}`;
    
    console.log('Generating QR code for:', otpauth);
    
    // Generate QR code
    QRCode.toCanvas(canvas, otpauth, {
      width: 256,
      margin: 1,
      color: {
        dark: '#000000',
        light: '#FFFFFF'
      }
    }, function (error) {
      if (error) {
        console.error('QR Code generation error:', error);
        // Fallback: show text if QR fails
        const container = canvas.parentElement;
        if (container) {
          container.innerHTML = `<div class="text-gray-600 text-sm text-center p-8">Failed to generate QR code. Please use the manual code below.</div>`;
        }
      } else {
        console.log('QR code generated successfully');
      }
    });
  };

  const check2FAStatus = () => {
    return localStorage.getItem(STORAGE_KEY) === 'true';
  };

  const updateUI = () => {
    const enabled = check2FAStatus();
    const statusEl = document.getElementById('2faStatus');
    const statusText = document.getElementById('statusText');
    const toggleBtn = document.getElementById('toggleBtn');
    const setupSection = document.getElementById('setupSection');
    const backupCodes = document.getElementById('backupCodes');
    
    if (!statusEl || !statusText || !toggleBtn) return;
    
    if (enabled) {
      statusEl.classList.remove('bg-gray-700/40');
      statusEl.classList.add('bg-gradient-to-br', 'from-green-900/20', 'to-emerald-900/20', 'border-green-700/50');
      statusText.textContent = 'Enabled and active';
      statusText.classList.remove('text-gray-400');
      statusText.classList.add('text-green-400');
      toggleBtn.textContent = 'Disable 2FA';
      toggleBtn.classList.remove('from-purple-600', 'to-purple-700', 'hover:from-purple-700', 'hover:to-purple-800');
      toggleBtn.classList.add('from-red-600', 'to-red-700', 'hover:from-red-700', 'hover:to-red-800');
      setupSection?.classList.add('hidden');
      backupCodes?.classList.remove('hidden');
    } else {
      statusEl.classList.add('bg-gray-700/40');
      statusEl.classList.remove('bg-gradient-to-br', 'from-green-900/20', 'to-emerald-900/20', 'border-green-700/50');
      statusText.textContent = 'Not enabled';
      statusText.classList.add('text-gray-400');
      statusText.classList.remove('text-green-400');
      toggleBtn.textContent = 'Enable 2FA';
      toggleBtn.classList.add('from-purple-600', 'to-purple-700', 'hover:from-purple-700', 'hover:to-purple-800');
      toggleBtn.classList.remove('from-red-600', 'to-red-700', 'hover:from-red-700', 'hover:to-red-800');
      setupSection?.classList.add('hidden');
      backupCodes?.classList.add('hidden');
    }
  };

  document.getElementById('toggleBtn')?.addEventListener('click', () => {
    const enabled = check2FAStatus();
    if (enabled) {
      if (confirm('Are you sure you want to disable two-factor authentication? This will make your account less secure.')) {
        localStorage.setItem(STORAGE_KEY, 'false');
        updateUI();
      }
    } else {
      const setupSection = document.getElementById('setupSection');
      const secretCode = document.getElementById('secretCode');
      setupSection?.classList.remove('hidden');
      if (secretCode) {
        const secret = generateSecret();
        secretCode.textContent = formatSecret(secret);
        // Generate QR code with the raw secret (no spaces)
        generateQRCode(secret);
      }
    }
  });

  document.getElementById('cancelBtn')?.addEventListener('click', () => {
    const setupSection = document.getElementById('setupSection');
    setupSection?.classList.add('hidden');
  });

  document.getElementById('verifyForm')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const codeInput = document.getElementById('verifyCode');
    if (codeInput && codeInput.value.length === 6) {
      localStorage.setItem(STORAGE_KEY, 'true');
      codeInput.value = '';
      updateUI();
      alert('Two-factor authentication has been enabled successfully!');
    }
  });

  updateUI();
</script>
